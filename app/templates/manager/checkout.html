{% extends "base.html" %}

{% block content %}
<h2>Checkout</h2>
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">Order Summary</div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for item in cart_items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ item.product.name }}</strong> (x{{ item.quantity }})
                            <br><small class="text-muted">from {{ item.product.supplier.shop_name }}</small>
                        </div>
                        <span>₹{{ "%.2f"|format(item.price_at_purchase * item.quantity) }}</span>
                    </li>
                    {% endfor %}
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                        <h4>Total</h4>
                        <h4>₹{{ "%.2f"|format(total_amount) }}</h4>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Payment</div>
            <div class="card-body">
                <form method="post">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.payment_method.label(class="form-label") }}
                        {% for subfield in form.payment_method %}
                        <div class="form-check">
                            {{ subfield(class="form-check-input") }}
                            {{ subfield.label(class="form-check-label") }}
                        </div>
                        {% endfor %}
                    </div>
                    {% if order %}
                        <button id="rzp-button1" class="btn btn-primary w-100">Pay ₹{{ "%.2f"|format(total_amount) }}</button>
                    {% else %}
                        {{ form.submit(class="btn btn-primary w-100") }}
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

{% if order %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
var options = {
    "key": "{{ razorpay_key_id }}",
    "amount": "{{ order.amount }}", 
    "currency": "INR",
    "name": "Aquajal Procurement",
    "description": "Supplier Product Purchase",
    "order_id": "{{ order.id }}",
    "handler": function (response){
        // Here you would typically submit this to a new route to verify the payment
        // and create the PurchaseOrder in your database.
        alert("Payment Successful! In a real app, you would now verify this on the server.");
        window.location.href = "{{ url_for('manager.dashboard') }}";
    },
    "prefill": {
        "name": "{{ current_user.username }}",
        "email": "{{ current_user.business.email or '' }}",
        "contact": "{{ current_user.mobile_number or '' }}"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();
    e.preventDefault();
}
</script>
{% endif %}
{% endblock %}