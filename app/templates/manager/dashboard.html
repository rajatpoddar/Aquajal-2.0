{% extends "base.html" %}

{% block content %}

{# --- SUBSCRIPTION STATUS BANNER --- #}
{% set business = current_user.business %}
{% if business %}
    {% if business.subscription_status == 'trial' and business.trial_ends_at %}
        {% set days_left = (business.trial_ends_at.date() - now.date()).days %}
        <div class="alert alert-warning d-flex align-items-center justify-content-between shadow-sm" role="alert">
            <div>
                <i class="bi bi-stopwatch-fill me-2"></i>
                You are on a trial period. <strong>{{ days_left }} day(s) remaining.</strong>
            </div>
            <a href="{{ url_for('billing.subscribe') }}" class="btn btn-sm btn-success fw-bold">Subscribe Now & Get Offer</a>
        </div>
    {% elif business.subscription_status == 'active' and business.subscription_ends_at %}
         {% set days_left = (business.subscription_ends_at.date() - now.date()).days %}
         {% if days_left <= 7 %}
         <div class="alert alert-danger d-flex align-items-center justify-content-between shadow-sm" role="alert">
            <div>
                 <i class="bi bi-exclamation-triangle-fill me-2"></i>
                 Your subscription is expiring soon! You have <strong>{{ days_left }} day(s)</strong> left.
            </div>
             <a href="{{ url_for('billing.subscribe') }}" class="btn btn-sm btn-primary">Renew Now</a>
         </div>
         {% endif %}
    {% endif %}
{% endif %}

{# --- LOW STOCK ALERT --- #}
{% if low_stock_jar %}
<div class="alert alert-danger shadow-sm" role="alert">
    <h4 class="alert-heading">Low Stock Alert!</h4>
    <p>Your jar stock is at <strong>{{ business.jar_stock }}</strong>, which is below your threshold of <strong>{{ business.low_stock_threshold }}</strong>. Don't let your customers down, re-stock now!</p>
    <hr>
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong>Best Price Available:</strong>
            {% if low_stock_jar.product.discount_percentage and low_stock_jar.product.discount_percentage > 0 %}
                <del>₹{{ "%.2f"|format(low_stock_jar.product.price) }}</del>
                <strong class="text-success">₹{{ "%.2f"|format(low_stock_jar.final_price) }}</strong>
            {% else %}
                ₹{{ "%.2f"|format(low_stock_jar.product.price) }}
            {% endif %}
            from {{ low_stock_jar.product.supplier.shop_name }}
        </div>
        <form action="{{ url_for('manager.add_to_cart', product_id=low_stock_jar.product.id) }}" method="post" class="d-flex">
            {{ quick_order_form.hidden_tag() }}
            <div class="input-group">
                {{ quick_order_form.quantity(class="form-control", style="width: 80px;") }}
                {{ quick_order_form.submit(class="btn btn-success") }}
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if low_stock_dispenser %}
<div class="alert alert-warning shadow-sm" role="alert">
    <h4 class="alert-heading">Low Stock Alert!</h4>
    <p>Your dispenser stock is at <strong>{{ business.dispenser_stock }}</strong>, which is below your threshold of <strong>{{ business.low_stock_threshold_dispenser }}</strong>.</p>
    <hr>
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong>Best Price Available:</strong>
            {% if low_stock_dispenser.product.discount_percentage and low_stock_dispenser.product.discount_percentage > 0 %}
                <del>₹{{ "%.2f"|format(low_stock_dispenser.product.price) }}</del>
                <strong class="text-success">₹{{ "%.2f"|format(low_stock_dispenser.final_price) }}</strong>
            {% else %}
                ₹{{ "%.2f"|format(low_stock_dispenser.product.price) }}
            {% endif %}
            from {{ low_stock_dispenser.product.supplier.shop_name }}
        </div>
        <form action="{{ url_for('manager.add_to_cart', product_id=low_stock_dispenser.product.id) }}" method="post" class="d-flex">
            {{ quick_order_form.hidden_tag() }}
            <div class="input-group">
                {{ quick_order_form.quantity(class="form-control", style="width: 80px;") }}
                {{ quick_order_form.submit(class="btn btn-success") }}
            </div>
        </form>
    </div>
</div>
{% endif %}

{# --- DASHBOARD TITLE --- #}
<div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center mb-4">
    <h2 class="mb-3 mb-md-0">Manager Dashboard</h2>
</div>

{# --- QUICK ACTION BUTTONS --- #}
<div class="row row-cols-3 row-cols-md-6 g-2 mb-4 text-center">
    <div class="col">
        <a href="{{ url_for('manager.book_event') }}" class="d-block p-3 rounded-3 text-decoration-none bg-info-subtle text-info-emphasis shadow-sm h-100 d-flex flex-column justify-content-center btn-hover-lift">
            <i class="bi bi-calendar-plus-fill fs-2 mb-1"></i>
            <span class="fw-bold">Book Event</span>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('manager.browse_products') }}" class="d-block p-3 rounded-3 text-decoration-none bg-success-subtle text-success-emphasis shadow-sm h-100 d-flex flex-column justify-content-center btn-hover-lift">
            <i class="bi bi-shop fs-2 mb-1"></i>
            <span class="fw-bold">Procure</span>
        </a>
    </div>
     <div class="col">
        <a href="{{ url_for('customers.add_customer') }}" class="d-block p-3 rounded-3 text-decoration-none bg-primary-subtle text-primary-emphasis shadow-sm h-100 d-flex flex-column justify-content-center btn-hover-lift">
            <i class="bi bi-person-plus-fill fs-2 mb-1"></i>
            <span class="fw-bold">Add Customer</span>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('manager.stock_management') }}" class="d-block p-3 rounded-3 text-decoration-none bg-warning-subtle text-warning-emphasis shadow-sm h-100 d-flex flex-column justify-content-center btn-hover-lift">
            <i class="bi bi-box-seam fs-2 mb-1"></i>
            <span class="fw-bold">Manage Stocks</span>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('manager.settings') }}" class="d-block p-3 rounded-3 text-decoration-none bg-secondary-subtle text-secondary-emphasis shadow-sm h-100 d-flex flex-column justify-content-center btn-hover-lift">
            <i class="bi bi-gear-fill fs-2 mb-1"></i>
            <span class="fw-bold">Settings</span>
        </a>
    </div>
    <div class="col">
        <a href="{{ url_for('manager.reports') }}" class="d-block p-3 rounded-3 text-decoration-none bg-danger-subtle text-danger-emphasis shadow-sm h-100 d-flex flex-column justify-content-center btn-hover-lift">
            <i class="bi bi-file-earmark-bar-graph-fill fs-2 mb-1"></i>
            <span class="fw-bold">Reports</span>
        </a>
    </div>
</div>

{# --- Redesigned Summary Cards for Responsive View --- #}
<div class="row mb-4">

    <!-- Total Cash Card -->
    <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card text-white bg-primary shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between p-3">
                <div>
                    <h6 class="card-title text-uppercase mb-1">Total Cash Held By Staff</h6>
                    <p class="card-text display-5 mb-2">₹{{ "%.2f"|format(total_staff_balance) }}</p>
                </div>
                <a href="#staff-balances" class="btn btn-light fw-bold w-100">
                    Settle Balances <i class="bi bi-arrow-down-circle ms-1"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Total Dues Card -->
    <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card text-white bg-danger shadow-sm h-100">
            <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                <h6 class="card-title text-uppercase mb-1">Total Dues from Customers</h6>
                <p class="card-text display-5 mb-0">₹{{ "%.2f"|format(total_dues) }}</p>
            </div>
        </div>
    </div>

    <!-- Available Jar Stock Card -->
    <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card text-white bg-info shadow-sm h-100">
            <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                <h6 class="card-title text-uppercase mb-1"><i class="bi bi-droplet-half"></i> Jar Stock</h6>
                <p class="card-text display-5 mb-0">{{ business.jar_stock if business else 'N/A' }}</p>
            </div>
        </div>
    </div>

    <!-- Available Dispenser Stock Card -->
    <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card text-dark bg-light shadow-sm h-100">
            <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                <h6 class="card-title text-uppercase mb-1"><i class="bi bi-funnel-fill"></i> Dispenser Stock</h6>
                <p class="card-text display-5 mb-0">{{ business.dispenser_stock if business else 'N/A' }}</p>
            </div>
        </div>
    </div>
</div>


<h4 class="mt-4" id="staff-balances">Individual Staff Balances</h4>
<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Staff Username</th>
                        <th class="text-end">Cash on Hand</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for staff in staff_members %}
                    <tr>
                        <td>{{ staff.username }}</td>
                        <td class="text-end">
                            <span class="badge fs-6 {% if staff.cash_balance and staff.cash_balance > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                ₹{{ "%.2f"|format(staff.cash_balance if staff.cash_balance is not none else 0.0) }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if staff.cash_balance and staff.cash_balance > 0 %}
                            <form action="{{ url_for('manager.receive_cash', staff_id=staff.id) }}" method="post" onsubmit="return confirm('Are you sure you received this amount from {{ staff.username }}? This will reset their balance to zero.');">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="bi bi-cash-stack"></i> Receive Cash
                                </button>
                            </form>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center">No staff members found for your business.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<h4 class="mt-5">Pending Event Bookings</h4>
<div class="list-group">
    {% for booking in pending_bookings %}
    <div class="list-group-item">
        <div class="d-flex w-100 justify-content-between">
            <div>
                <h5 class="mb-1">{{ booking.customer.name }} - {{ booking.customer.mobile_number }}</h5>
                <p class="mb-1">
                    <strong>{{ booking.quantity }} Jar(s)</strong>
                    {% if booking.dispensers_booked and booking.dispensers_booked > 0 %}
                        + <strong>{{ booking.dispensers_booked }} Dispenser(s)</strong>
                    {% endif %}
                    for event on <strong>{{ booking.event_date.strftime('%d-%b-%Y') }}</strong>
                </p>
                <small>Location: {{ booking.customer.area }}, {{ booking.customer.village }}</small>
            </div>
            <div class="my-auto">
                <a href="{{ url_for('manager.confirm_booking', booking_id=booking.id) }}" class="btn btn-success">Confirm</a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="list-group-item">No pending event bookings.</div>
    {% endfor %}
</div>
{% endblock %}

