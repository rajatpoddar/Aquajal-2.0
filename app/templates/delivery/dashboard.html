{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-end mb-3">
        <a href="{{ url_for('sales.new_product_sale') }}" class="btn btn-success">
            <i class="bi bi-plus-circle-fill"></i> Sell New Jar / Dispenser
        </a>
    </div>
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card text-center text-white bg-success shadow">
                <div class="card-body">
                    <h5 class="card-title">Your Current Cash Balance</h5>
                    <p class="card-text display-4">₹{{ "%.2f"|format(current_user.cash_balance if current_user.cash_balance is not none else 0.0) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">Add an Expense</h5>
                    <form action="{{ url_for('delivery.add_expense') }}" method="post" class="row g-3 align-items-center">
                        {{ expense_form.hidden_tag() }}
                        <div class="col-sm-4">
                            {{ expense_form.amount(class="form-control", placeholder="Amount") }}
                        </div>
                        <div class="col-sm-5">
                            {{ expense_form.description(class="form-control", placeholder="Description") }}
                        </div>
                        <div class="col-sm-3">
                            {{ expense_form.submit_expense(class="btn btn-warning w-100") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 mb-4">
        <div class="col-md-6 mb-3">
            <h4>Pending Jar Requests</h4>
            <div class="list-group">
                {% for req in jar_requests %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h5 class="mb-1">{{ req.customer.name }}</h5>
                            <p class="mb-1">Wants <strong>{{ req.quantity }} jar(s)</strong></p>
                            <small>{{ req.customer.area }}, {{ req.customer.village }}</small>
                        </div>
                        <div class="my-auto">
                            <a href="{{ url_for('delivery.confirm_jar_request', request_id=req.id) }}" class="btn btn-sm btn-success" onclick="return confirm('Confirm delivery of {{req.quantity}} jar(s) to {{req.customer.name}}?')">
                                <i class="bi bi-check-circle-fill"></i> Delivered
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="list-group-item">No pending jar requests.</div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <h4>Today's Event Deliveries</h4>
            <div class="list-group">
                {% for event in event_bookings_today %}
                <div class="list-group-item list-group-item-warning">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h5 class="mb-1">{{ event.customer.name }}</h5>
                            <p class="mb-1"><strong>{{ event.quantity }} Jars</strong> for event. Amount: ₹{{ "%.2f"|format(event.amount) }}</p>
                            <small>{{ event.customer.area }}, {{ event.customer.village }}</small><br>
                            {% if event.paid_to_manager %}<span class="badge bg-secondary">Pre-Paid to Manager</span>{% else %}<span class="badge bg-danger">Collect Payment</span>{% endif %}
                        </div>
                        <div class="my-auto">
                            <a href="{{ url_for('delivery.confirm_event_delivery', booking_id=event.id) }}" class="btn btn-sm btn-success" onclick="return confirm('Confirm EVENT delivery to {{event.customer.name}}?')">
                                 <i class="bi bi-check-circle-fill"></i> Delivered
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="list-group-item">No event deliveries for today.</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <h5 class="card-title">Find a Customer</h5>
            <div class="input-group">
                {{ search_form.search_term(id="customer-search-input", class="form-control form-control-lg", placeholder="Start typing a name or mobile number...") }}
            </div>
        </div>
    </div>

    <div id="customer-results-container" class="list-group">
        </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('customer-search-input');
    const resultsContainer = document.getElementById('customer-results-container');
    let debounceTimer;

    searchInput.addEventListener('keyup', function() {
        clearTimeout(debounceTimer);
        const query = searchInput.value;

        // Use a debounce timer to avoid sending too many requests while typing
        debounceTimer = setTimeout(() => {
            if (query.length < 2) {
                resultsContainer.innerHTML = ''; // Clear results if query is too short
                return;
            }

            // Fetch results from our new API endpoint
            fetch(`{{ url_for('delivery.search_customers') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.length > 0) {
                        data.forEach(customer => {
                            // Format the price to two decimal places
                            const price = customer.price_per_jar.toFixed(2);

                            // Build the HTML for each customer
                            html += `
                                <div class="list-group-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-5">
                                            <h5 class="mb-1">${customer.name}</h5>
                                            <p class="mb-1"><i class="bi bi-geo-alt-fill"></i> ${customer.area}, ${customer.village}</p>
                                            <small>Default: ${customer.daily_jars} Jar(s) at ₹${price}</small>
                                        </div>
                                        <div class="col-md-7">
                                            <form action="/log_delivery/${customer.id}" method="post" class="row g-2 align-items-center justify-content-end">
                                                <div class="col-auto">
                                                    <label for="jars_delivered-${customer.id}" class="col-form-label">Jars:</label>
                                                </div>
                                                <div class="col-auto">
                                                    <input type="number" name="jars_delivered" id="jars_delivered-${customer.id}" class="form-control" value="${customer.daily_jars}" style="width: 80px;">
                                                </div>
                                                <div class="col-auto">
                                                     <button type="submit" class="btn btn-success"><i class="bi bi-truck"></i> Deliver</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html = '<div class="alert alert-warning">No customers found.</div>';
                    }
                    resultsContainer.innerHTML = html;
                })
                .catch(error => console.error('Error:', error));
        }, 300); // Wait 300ms after the user stops typing
    });
});
</script>
{% endblock %}
