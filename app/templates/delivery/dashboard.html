{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-end mb-3">
        <a href="{{ url_for('delivery.book_event') }}" class="btn btn-info me-2">
            <i class="bi bi-calendar-plus-fill"></i> {{ _('Book Jars for Event') }}
        </a>
        <a href="{{ url_for('sales.new_product_sale') }}" class="btn btn-success">
            <i class="bi bi-plus-circle-fill"></i> {{ _('Sell New Jar / Dispenser') }}
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <h5 class="card-title">{{ _('Supply Jar') }}</h5>
            <div class="input-group">
                {{ search_form.search_term(id="customer-search-input", class="form-control form-control-lg", placeholder=_('Start typing a name or mobile number...')) }}
            </div>
        </div>
    </div>

    <div id="customer-results-container" class="list-group mb-4">
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card text-center text-white bg-success shadow">
                <div class="card-body">
                    <h5 class="card-title">{{ _('Your Current Cash Balance') }}</h5>
                    <p class="card-text display-4">₹{{ "%.2f"|format(current_user.cash_balance if current_user.cash_balance is not none else 0.0) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">{{ _('Add an Expense') }}</h5>
                    <form action="{{ url_for('delivery.add_expense') }}" method="post" class="row g-3 align-items-center">
                        {{ expense_form.hidden_tag() }}
                        <div class="col-sm-4">
                            {{ expense_form.amount(class="form-control", placeholder=_('Amount')) }}
                        </div>
                        <div class="col-sm-5">
                            {{ expense_form.description(class="form-control", placeholder=_('Description')) }}
                        </div>
                        <div class="col-sm-3">
                            {{ expense_form.submit_expense(class="btn btn-warning w-100") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h4 class="mt-4">{{ _('Customers with Dues') }}</h4>
            <div class="list-group mb-4">
                {% for customer in customers_with_dues %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h5 class="mb-1">{{ customer.name }}</h5>
                            <p class="mb-1">
                                <strong class="text-danger">{{ _('Due:') }} ₹{{ "%.2f"|format(customer.due_amount) }}</strong>
                            </p>
                            <small><i class="bi bi-geo-alt-fill"></i> {{ customer.area }}, {{ customer.village }}</small>
                        </div>
                        <div class="my-auto">
                             <form action="{{ url_for('delivery.clear_dues') }}" method="post" onsubmit="return confirm('{{ _('Confirm you have received') }} ₹{{ customer.due_amount }} {{ _('from') }} {{ customer.name }}?');">
                                {{ clear_dues_form.hidden_tag() }}
                                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="bi bi-check-circle-fill"></i> {{ _('Mark as Paid') }}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="list-group-item">{{ _('No customers have outstanding dues.') }}</div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <h4 class="mt-4">{{ _('Event Jars to Collect') }}</h4>
            <div class="list-group mb-4">
                {% for booking in bookings_to_collect %}
                <div class="list-group-item list-group-item-action">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <h5 class="mb-1">{{ booking.customer.name }}</h5>
                            <p class="mb-1">
                                <i class="bi bi-box-seam"></i> <strong>{{ booking.quantity }} {{ _('Jars') }}</strong>
                                {# FIX: Check if dispensers_booked is not None #}
                                {% if booking.dispensers_booked and booking.dispensers_booked > 0 %}
                                + <strong>{{ booking.dispensers_booked }} {{ _('Dispenser(s)') }}</strong>
                                {% endif %}
                            </p>
                            <small><i class="bi bi-geo-alt-fill"></i> {{ booking.customer.area }}, {{ booking.customer.village }}</small>
                        </div>
                        <div class="col-md-7">
                            <form action="{{ url_for('delivery.collect_event_jars', booking_id=booking.id) }}" method="post" class="row g-2 align-items-center justify-content-end">
                                <div class="col-auto">
                                    <label for="jars_returned-{{ booking.id }}" class="col-form-label">{{ _('Jars Ret:') }}</label>
                                    <input type="number" name="jars_returned" id="jars_returned-{{ booking.id }}" class="form-control" value="{{ booking.quantity }}" min="0" max="{{ booking.quantity }}" style="width: 80px;">
                                </div>
                                {# FIX: Check if dispensers_booked is not None #}
                                {% if booking.dispensers_booked and booking.dispensers_booked > 0 %}
                                <div class="col-auto">
                                    <label for="dispensers_returned-{{ booking.id }}" class="col-form-label">{{ _('Dispen Ret:') }}</label>
                                    <input type="number" name="dispensers_returned" id="dispensers_returned-{{ booking.id }}" class="form-control" value="{{ booking.dispensers_booked }}" min="0" max="{{ booking.dispensers_booked }}" style="width: 80px;">
                                </div>
                                {% else %}
                                    <input type="hidden" name="dispensers_returned" value="0">
                                {% endif %}
                                <div class="col-auto">
                                     <button type="submit" class="btn btn-primary"><i class="bi bi-check-all"></i> {{ _('Collect') }}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="list-group-item">{{ _('No event items pending collection.') }}</div>
                {% endfor %}
            </div>
        </div>
    </div>


    <div class="row mt-4 mb-4">
        <div class="col-md-6 mb-3">
            <h4>{{ _('Pending Jar Requests') }}</h4>
            <div class="list-group">
                {% for req in jar_requests %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h5 class="mb-1">{{ req.customer.name }}</h5>
                            <p class="mb-1">{{ _('Wants') }} <strong>{{ req.quantity }} {{ _('jar(s)') }}</strong></p>
                            <small>{{ req.customer.area }}, {{ req.customer.village }}</small>
                        </div>
                        <div class="my-auto">
                            <a href="{{ url_for('delivery.confirm_jar_request', request_id=req.id) }}" class="btn btn-sm btn-success" onclick="return confirm('{{ _('Confirm delivery of %(qty)s jar(s) to %(name)s?', qty=req.quantity, name=req.customer.name) }}');">
                                <i class="bi bi-check-circle-fill"></i> {{ _('Delivered') }}
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="list-group-item">{{ _('No pending jar requests.') }}</div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <h4>{{ _('Today\'s Event Deliveries') }}</h4>
            <div class="list-group">
                {% for event in event_bookings_today %}
                <div class="list-group-item list-group-item-warning">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h5 class="mb-1">{{ event.customer.name }}</h5>
                            <a href="tel:{{ event.customer.mobile_number }}" class="text-decoration-none text-dark">{{ event.customer.mobile_number }}</a>
                            <p class="mb-1">
                                <strong>{{ event.quantity }} {{ _('Jars') }}</strong>
                                {# FIX: Check if dispensers_booked is not None #}
                                {% if event.dispensers_booked and event.dispensers_booked > 0 %}+ <strong>{{ event.dispensers_booked }} {{ _('Dispenser(s)') }}</strong>{% endif %}
                                {{ _('for event. Amount:') }} ₹{{ "%.2f"|format(event.amount) }}
                            </p>
                            <small>{{ event.customer.area }}, {{ event.customer.village }}</small><br>
                            {% if event.paid_to_manager %}<span class="badge bg-secondary">{{ _('Pre-Paid to Manager') }}</span>{% else %}<span class="badge bg-danger">{{ _('Collect Payment') }}</span>{% endif %}
                        </div>
                        <div class="my-auto">
                            <a href="{{ url_for('delivery.confirm_event_delivery', booking_id=event.id) }}" class="btn btn-sm btn-success" onclick="return confirm('{{ _('Confirm EVENT delivery to %(name)s?', name=event.customer.name) }}');">
                                 <i class="bi bi-check-circle-fill"></i> {{ _('Delivered') }}
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="list-group-item">{{ _('No event deliveries for today.') }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{# --- QR Code Modal --- #}
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrCodeModalLabel">Scan UPI QR Code to Pay</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
           <p>Ask customer to scan the code below using their UPI app.</p>
           <img id="qrCodeImage" src="" alt="UPI QR Code" class="img-fluid mb-3" style="max-width: 300px;">
           <p><strong>Amount: ₹<span id="qrAmount"></span></strong><br>
              <small>UPI ID: <span id="qrUpiId"></span></small></p>
           <p class="text-danger fw-bold">IMPORTANT: After customer shows successful payment confirmation, click 'Payment Received'.</p>
           {# Hidden form fields to be populated by JS before submitting #}
           <input type="hidden" id="qrCustomerId" name="customer_id">
           <input type="hidden" id="qrJarsDelivered" name="jars_delivered">
           <input type="hidden" name="payment_received_online" value="true"> {# Indicate online payment #}
           <button type="button" id="paymentReceivedBtn" class="btn btn-success btn-lg">
               <i class="bi bi-check-circle-fill"></i> Payment Received & Log Delivery
           </button>
        </div>
      </div>
    </div>
  </div>
  {# --- End QR Code Modal --- #}
  
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('customer-search-input');
      const resultsContainer = document.getElementById('customer-results-container');
      const qrCodeModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
      const qrCodeImage = document.getElementById('qrCodeImage');
      const qrAmountSpan = document.getElementById('qrAmount');
      const qrUpiIdSpan = document.getElementById('qrUpiId');
      const paymentReceivedBtn = document.getElementById('paymentReceivedBtn');
      const qrCustomerIdInput = document.getElementById('qrCustomerId');
      const qrJarsDeliveredInput = document.getElementById('qrJarsDelivered');
  
      let debounceTimer;
  
      // --- Existing Search Input Logic ---
      searchInput.addEventListener('keyup', function() {
          clearTimeout(debounceTimer);
          const query = searchInput.value;
  
          debounceTimer = setTimeout(() => {
              if (query.length < 2) {
                  resultsContainer.innerHTML = '';
                  return;
              }
  
              fetch(`{{ url_for('delivery.search_customers') }}?q=${encodeURIComponent(query)}`)
                  .then(response => response.json())
                  .then(data => {
                      let html = '';
                      if (data.length > 0) {
                          data.forEach(customer => {
                              const price = customer.price_per_jar.toFixed(2);
                              const defaultAmount = (customer.daily_jars * customer.price_per_jar).toFixed(2);
                              html += `
                                  <div class="list-group-item">
                                      <div class="row align-items-center">
                                          <div class="col-md-5">
                                              <h5 class="mb-1">${customer.name}</h5>
                                              <p class="mb-1"><i class="bi bi-geo-alt-fill"></i> ${customer.area || ''}, ${customer.village || ''}</p>
                                              <small>{{ _('Default:') }} ${customer.daily_jars} {{ _('Jar(s) at') }} ₹${price}</small>
                                          </div>
                                          <div class="col-md-7">
                                              {# Form for Cash/Due Delivery #}
                                              <form action="/log_delivery/${customer.id}" method="post" class="row g-2 align-items-center justify-content-end delivery-log-form" id="form-cash-${customer.id}">
                                                  <div class="col-auto">
                                                      <label for="jars_delivered-${customer.id}" class="col-form-label visually-hidden">{{ _('Jars:') }}</label>
                                                      <input type="number" name="jars_delivered" id="jars_delivered-${customer.id}" class="form-control jars-input" value="${customer.daily_jars}" style="width: 80px;" min="1">
                                                  </div>
                                                  <div class="col-auto">
                                                      <div class="form-check form-switch">
                                                          <input class="form-check-input" type="checkbox" role="switch" name="is_due" value="true" id="is_due-${customer.id}">
                                                          <label class="form-check-label" for="is_due-${customer.id}">{{ _('Mark as Due') }}</label>
                                                      </div>
                                                  </div>
                                                  <div class="col-auto">
                                                       <button type="submit" class="btn btn-success btn-sm"><i class="bi bi-truck"></i> {{ _('Deliver') }} (Cash/Due)</button>
                                                  </div>
                                                  {# Pay Online Button #}
                                                  <div class="col-auto">
                                                      <button type="button" class="btn btn-info btn-sm btn-pay-online"
                                                              data-customer-id="${customer.id}"
                                                              data-customer-name="${customer.name}"
                                                              data-price-per-jar="${customer.price_per_jar}">
                                                          <i class="bi bi-qr-code"></i> Pay Online
                                                      </button>
                                                  </div>
                                              </form>
                                              {# Hidden Form specifically for QR Payment Confirmation #}
                                              <form action="/log_delivery/${customer.id}" method="post" id="form-online-${customer.id}" style="display: none;">
                                                   <input type="hidden" name="jars_delivered" class="online-jars-input" value="${customer.daily_jars}">
                                                   <input type="hidden" name="payment_received_online" value="true">
                                              </form>
                                          </div>
                                      </div>
                                  </div>
                              `;
                          });
                      } else {
                          html = `<div class="alert alert-warning">{{ _('No customers found.') }}</div>`;
                      }
                      resultsContainer.innerHTML = html;
                      attachPayOnlineListeners(); // Attach listeners after results are loaded
                  })
                  .catch(error => console.error('Error:', error));
          }, 300);
      });
  
      // --- Function to Attach Listeners to Pay Online Buttons ---
      function attachPayOnlineListeners() {
          document.querySelectorAll('.btn-pay-online').forEach(button => {
              button.addEventListener('click', function() {
                  const customerId = this.dataset.customerId;
                  const pricePerJar = parseFloat(this.dataset.pricePerJar);
                  const jarsInput = document.getElementById(`jars_delivered-${customerId}`);
                  const jars = parseInt(jarsInput.value) || 1; // Get current jar quantity
                  const amount = (jars * pricePerJar).toFixed(2);
  
                  if (amount <= 0) {
                      alert('Please enter a valid number of jars.');
                      return;
                  }
  
                  // Show loading state (optional)
                  qrCodeImage.src = ""; // Clear previous QR
                  qrAmountSpan.textContent = amount;
                  qrUpiIdSpan.textContent = 'Loading...';
                  qrCustomerIdInput.value = customerId; // Store customer ID for confirmation
                  qrJarsDeliveredInput.value = jars; // Store jar count for confirmation
  
                  qrCodeModal.show();
  
                  // Fetch QR Code from backend
                  fetch(`/generate_upi_qr/${customerId}/${amount}`)
                      .then(response => {
                          if (!response.ok) {
                              throw new Error('Failed to generate QR code.');
                          }
                          return response.json();
                      })
                      .then(data => {
                          qrCodeImage.src = data.qr_image_data;
                          qrUpiIdSpan.textContent = data.upi_id;
                      })
                      .catch(error => {
                          console.error('Error fetching QR code:', error);
                          qrUpiIdSpan.textContent = 'Error loading QR';
                          alert('Could not generate QR code. Check if UPI ID is set in manager settings.');
                           qrCodeModal.hide(); // Hide modal on error
                      });
              });
          });
          // Update hidden online forms when jar input changes
          document.querySelectorAll('.jars-input').forEach(input => {
               input.addEventListener('change', function() {
                   const customerId = this.id.split('-')[1];
                   const onlineJarsInput = document.querySelector(`#form-online-${customerId} .online-jars-input`);
                   if(onlineJarsInput) {
                       onlineJarsInput.value = this.value;
                   }
               });
          });
      }
  
       // --- Listener for Payment Received Button in Modal ---
       paymentReceivedBtn.addEventListener('click', function() {
          const customerId = qrCustomerIdInput.value;
          const onlineForm = document.getElementById(`form-online-${customerId}`);
          if (onlineForm) {
              onlineForm.submit(); // Submit the hidden form to log delivery as paid online
          } else {
              console.error('Could not find the corresponding online payment form.');
              alert('Error logging delivery. Please refresh and try again.');
          }
          qrCodeModal.hide(); // Hide modal after clicking
      });
  
  });
  </script>
  {% endblock %}