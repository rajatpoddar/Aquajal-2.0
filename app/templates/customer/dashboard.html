{% extends "base.html" %}

{% block content %}
<h2>{{ _('Welcome,') }} {{ current_user.name }}!</h2>
<hr>

{% if due_amount > 0 %}
<div class="alert alert-danger shadow-sm">
    <h4 class="alert-heading">{{ _('Outstanding Balance') }}</h4>
    <p>{{ _('You have a due amount of') }} <strong>₹{{ "%.2f"|format(due_amount) }}</strong>. {{ _('Please clear it with the delivery staff by the end of the month to avoid any interruptions in service.') }}</p>
</div>
{% endif %}

<div class="row">
    <div class="col-md-4">
        <h4>{{ _('Quick Actions') }}</h4>
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">{{ _('Request Daily Jars') }}</h5>
                <form action="{{ url_for('customer.request_jar') }}" method="post">
                    {{ jar_form.hidden_tag() }}
                    <div class="mb-2">{{ jar_form.quantity.label }} {{ jar_form.quantity(class="form-control") }}</div>
                    <div>{{ jar_form.submit(class="btn btn-success") }}</div>
                </form>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">{{ _('Book for an Event') }}</h5>
                <form action="{{ url_for('customer.book_event') }}" method="post">
                    {{ event_form.hidden_tag() }}
                    <div class="mb-2">{{ event_form.quantity.label }} {{ event_form.quantity(class="form-control") }}</div>
                    <div class="mb-2">{{ event_form.event_date.label }} {{ event_form.event_date(class="form-control") }}</div>
                    <div>{{ event_form.submit(class="btn btn-info") }}</div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button">{{ _('My Activity') }}</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button">{{ _('Invoices') }}</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade" id="activity" role="tabpanel">
                <ul class="list-group list-group-flush">
                    {% for activity in activity_log %}
                        {% set item = activity.item %}
                        <li class="list-group-item">
                            {% if activity.type == 'Regular Delivery' or activity.type == 'Requested Delivery' %}
                                <div class="d-flex w-100 justify-content-between">
                                    <div>
                                        <strong>{{ item.jars_delivered }} {{ _('jar(s)') }}</strong> {{ _('delivered on') }} {{(item.timestamp | to_ist).strftime('%d-%b-%Y %I:%M %p')}}
                                        <small class="d-block text-muted">{{ _(activity.type) }}</small>
                                    </div>
                                    <div class="text-end">
                                        {{ _('Amount:') }} ₹{{ "%.2f"|format(item.amount_collected) }}
                                        {% if item.payment_status == 'Due' %}
                                            <span class="badge bg-danger ms-1">{{ _('Due') }}</span>
                                        {% else %}
                                            <span class="badge bg-success ms-1">{{ _('Paid') }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% elif activity.type == 'Booking Delivery' %}
                                <div class="d-flex w-100 justify-content-between">
                                    <div>
                                        {{ _('Booked') }} <strong>{{ item.quantity }} {{ _('Jar(s)') }}</strong>
                                        {% if item.dispensers_booked > 0 %}+ <strong>{{ item.dispensers_booked }} {{ _('Dispenser(s)') }}</strong>{% endif %}
                                        {{ _('for event on') }} {{ item.event_date.strftime('%d-%b-%Y') }}
                                        <small class="d-block text-muted">{{ _('Booking Delivery') }}</small>
                                    </div>
                                    <span class="badge bg-warning my-auto">{{ _(item.status) }}</span>
                                </div>
                                {% if item.status == 'Completed' %}
                                    <hr class="my-2">
                                    <small class="d-block">
                                        {{ _('Returned:') }} {{ item.jars_returned }} {{ _('Jars') }}, {{ item.dispensers_returned or 0 }} {{ _('Dispensers') }}.
                                        {% set lost_jars = item.quantity - item.jars_returned %}
                                        {% set lost_dispensers = (item.dispensers_booked or 0) - (item.dispensers_returned or 0) %}
                                        {% if lost_jars > 0 or lost_dispensers > 0 %}
                                            <span class="text-danger">
                                                {{ _('Lost:') }}
                                                {% if lost_jars > 0 %}{{ lost_jars }} {{ _('Jar(s)') }}{% endif %}
                                                {% if lost_dispensers > 0 %}, {{ lost_dispensers }} {{ _('Dispenser(s)') }}{% endif %}
                                            </span>
                                        {% endif %}
                                    </small>
                                    <small class="d-block"><strong>{{ _('Final Settled Amount:') }} ₹{{ "%.2f"|format(item.final_amount) }}</strong></small>
                                {% elif item.amount %}
                                    <small class="d-block">{{ _('Confirmed Amount:') }} ₹{{ "%.2f"|format(item.amount) }}</small>
                                {% endif %}
                            {% endif %}
                        </li>
                    {% else %}
                        <li class="list-group-item">{{ _('No recent activity found.') }}</li>
                    {% endfor %}
                </ul>
                {% if total_activity_pages > 1 %}
                <nav class="mt-3">
                    <ul class="pagination">
                        {% for p in range(1, total_activity_pages + 1) %}
                            <li class="page-item {% if p == page_activity %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('customer.dashboard', page_activity=p, page_invoices=request.args.get('page_invoices', 1), tab='activity') }}">{{ p }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="tab-pane fade" id="invoices" role="tabpanel">
                <ul class="list-group list-group-flush">
                    {% for invoice in invoices_pagination.items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>#{{ invoice.invoice_number }}</strong> - {{ _('Issued:') }} {{ invoice.issue_date.strftime('%d-%b-%Y') }}
                            <span class="d-block">{{ _('Amount:') }} ₹{{ "%.2f"|format(invoice.total_amount) }}</span>
                        </div>
                        <div>
                            <a href="{{ url_for('invoices.view_invoice', invoice_id=invoice.id) }}" class="btn btn-sm btn-outline-secondary">{{ _('View') }}</a>
                            <a href="{{ url_for('invoices.download_invoice', invoice_id=invoice.id) }}" class="btn btn-sm btn-outline-primary">{{ _('Download') }}</a>
                        </div>
                    </li>
                    {% else %}
                    <li class="list-group-item">{{ _('No invoices found.') }}</li>
                    {% endfor %}
                </ul>
                {% if invoices_pagination.pages > 1 %}
                <nav class="mt-3">
                    <ul class="pagination">
                        {% for page_num in invoices_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if invoices_pagination.page == page_num %}
                                    <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
                                {% else %}
                                    <li class="page-item"><a class="page-link" href="{{ url_for('customer.dashboard', page_invoices=page_num, page_activity=request.args.get('page_activity', 1), tab='invoices') }}">{{ page_num }}</a></li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><a class="page-link" href="#">…</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    if (tab) {
        const tabEl = document.querySelector('#' + tab + '-tab');
        if (tabEl) {
            new bootstrap.Tab(tabEl).show();
        }
    } else {
        // Show the first tab by default if no tab is specified
        const firstTab = document.querySelector('#myTab .nav-link');
        if (firstTab) {
            new bootstrap.Tab(firstTab).show();
        }
    }
});
</script>
{% endblock %}